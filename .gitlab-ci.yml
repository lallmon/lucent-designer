# GitLab CI/CD Pipeline for DesignVibe
# Lean configuration optimized for fast feedback and quality gates

stages:
  - test

variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  # Disable pip version check for faster installs
  PIP_DISABLE_PIP_VERSION_CHECK: "1"
  # Suppress root user warning in Docker containers (safe in CI)
  PIP_ROOT_USER_ACTION: "ignore"
  # Run Qt in offscreen mode (no display needed for tests)
  QT_QPA_PLATFORM: "offscreen"
  # Add project root to Python path so tests can import source modules
  PYTHONPATH: "$CI_PROJECT_DIR"

# Cache pip packages to speed up subsequent runs
cache:
  paths:
    - .cache/pip

# Default configuration for all test jobs
.test_template:
  image: python:3.10-slim
  before_script:
    # Install ALL Qt/PySide6 system dependencies for headless testing
    - apt-get update -qq && apt-get install -y -qq
        libgl1
        libegl1
        libxkbcommon-x11-0
        libxcb-icccm4
        libxcb-image0
        libxcb-keysyms1
        libxcb-randr0
        libxcb-render-util0
        libxcb-xinerama0
        libxcb-xfixes0
        libxcb-shape0
        libxcb-cursor0
        libdbus-1-3
        libfontconfig1
        libglib2.0-0
        libgssapi-krb5-2
        libx11-6
        libx11-xcb1
        libxext6
        libxrender1
        libxkbcommon0
    # Install Python dependencies
    - pip install -q -r requirements.txt -r requirements-dev.txt

# Tests with coverage on merge requests and main branch
# Purpose: Quality gate before merge + coverage tracking on main
# Runtime: ~3-5 seconds
test:coverage:
  extends: .test_template
  stage: test
  script:
    - pytest --cov=. --cov-report=term --cov-report=xml --cov-report=html
  # Extract coverage percentage for GitLab UI
  coverage: '/TOTAL.*\s+(\d+%)$/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
    paths:
      - htmlcov/
    expire_in: 7 days
  rules:
    # Run on merge requests
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      when: always
    # Run on main/master branch
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      when: always

