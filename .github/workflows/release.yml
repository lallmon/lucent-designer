name: Build and Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:

jobs:
  build:
    name: Build ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    timeout-minutes: 60
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            platform: Linux
          # - os: macos-latest
          #   platform: macOS
          # - os: windows-latest
          #   platform: Windows
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
      
      - name: Install Qt dependencies (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq \
            libgl1 libegl1 libxkbcommon-x11-0 \
            libxcb-icccm4 libxcb-image0 libxcb-keysyms1 \
            libxcb-randr0 libxcb-render-util0 libxcb-xinerama0 \
            libxcb-xfixes0 libxcb-shape0 libxcb-cursor0 \
            libdbus-1-3 libfontconfig1 libglib2.0-0 \
            libgssapi-krb5-2 libx11-6 libx11-xcb1 \
            libxext6 libxrender1 libxkbcommon0 \
            fuse libfuse2 \
            build-essential patchelf
      
      - name: Install Python dependencies
        run: |
          pip install -r requirements.txt
          pip install nuitka ordered-set zstandard imageio
      - name: Inject version from git tag
        shell: bash
        run: |
          VERSION="${{ github.ref_name }}"
          VERSION_NUMBER="${VERSION#v}"
          
          # For non-tag builds (branches), use a dev version
          if [[ "$VERSION_NUMBER" == *"/"* ]]; then
            VERSION_NUMBER="0.0.0-dev"
          fi
          
          # Use temp file approach with | delimiter to avoid conflicts
          sed "s|__VERSION__|$VERSION_NUMBER|g" pysidedeploy.spec > pysidedeploy.spec.tmp
          mv pysidedeploy.spec.tmp pysidedeploy.spec
          sed "s|__VERSION__|$VERSION_NUMBER|g" main.py > main.py.tmp
          mv main.py.tmp main.py
          
          echo "Building version: $VERSION_NUMBER"
          
          # Export sanitized ref name for artifact naming (replace / with -)
          SAFE_REF_NAME=$(echo "${{ github.ref_name }}" | tr '/' '-')
          echo "SAFE_REF_NAME=$SAFE_REF_NAME" >> $GITHUB_ENV
      
      - name: Build with pyside6-deploy (Linux)
        if: matrix.os == 'ubuntu-latest'
        env:
          CC: gcc
          CXX: g++
        run: |
          pyside6-deploy -c pysidedeploy.spec --force
      
      - name: Build with pyside6-deploy (macOS/Windows)
        if: matrix.os != 'ubuntu-latest'
        run: |
          pyside6-deploy -c pysidedeploy.spec --force
      
      - name: Verify build output
        shell: bash
        run: |
          echo "=== Looking for build output ==="
          ls -la
          # Check for platform-specific output
          if [ -d "DesignVibe.app" ]; then
            echo "Found macOS app bundle: DesignVibe.app"
            ls -la DesignVibe.app/
          elif [ -f "DesignVibe.exe" ]; then
            echo "Found Windows executable: DesignVibe.exe"
          elif [ -f "DesignVibe.bin" ]; then
            echo "Found Linux executable: DesignVibe.bin"
          else
            echo "ERROR: No build output found"
            find . -maxdepth 1 \( -name "*.app" -o -name "*.exe" -o -name "*.bin" \) 2>/dev/null
            exit 1
          fi
      
      - name: Create AppImage (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          wget https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
          chmod +x linuxdeploy-x86_64.AppImage
          
          mkdir -p AppDir/usr/bin
          cp DesignVibe.bin AppDir/usr/bin/DesignVibe
          chmod +x AppDir/usr/bin/DesignVibe
          
          ./linuxdeploy-x86_64.AppImage \
            --appdir AppDir \
            --executable AppDir/usr/bin/DesignVibe \
            --desktop-file DesignVibe.desktop \
            --icon-file assets/appIcon.png \
            --output appimage
          
          mv DesignVibe-*.AppImage "DesignVibe-${SAFE_REF_NAME}-x86_64.AppImage"
      
      - name: Create DMG (macOS)
        if: matrix.os == 'macos-latest'
        run: |
          hdiutil create -volname "DesignVibe" \
            -srcfolder DesignVibe.app \
            -ov -format UDZO \
            "DesignVibe-${SAFE_REF_NAME}-macOS.dmg"
      
      - name: Create Installer (Windows)
        if: matrix.os == 'windows-latest'
        shell: bash
        run: |
          mv DesignVibe.exe "DesignVibe-${SAFE_REF_NAME}-Windows.exe"
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.platform }}-build
          path: DesignVibe-*
  
  release:
    name: Create GitHub Release
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
      
      - name: Generate release notes
        id: release_notes
        run: |
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          
          if [ -z "$PREV_TAG" ]; then
            COMMITS=$(git log --pretty=format:"- %s (%h)" --no-merges)
          else
            COMMITS=$(git log ${PREV_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges)
          fi
          
          echo "## What's Changed" > release_notes.md
          echo "" >> release_notes.md
          echo "$COMMITS" >> release_notes.md
          echo "" >> release_notes.md
          echo "## Downloads" >> release_notes.md
          echo "" >> release_notes.md
          echo "- **Linux**: DesignVibe-${{ github.ref_name }}-x86_64.AppImage" >> release_notes.md
          echo "- **macOS**: DesignVibe-${{ github.ref_name }}-macOS.dmg" >> release_notes.md
          echo "- **Windows**: DesignVibe-${{ github.ref_name }}-Windows.exe" >> release_notes.md
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          body_path: release_notes.md
          files: |
            Linux-build/*
            macOS-build/*
            Windows-build/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

