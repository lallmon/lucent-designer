name: Build and Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:

jobs:
  build:
    name: Build ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    timeout-minutes: 60
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            platform: Linux
          - os: macos-latest
            platform: macOS
          - os: windows-latest
            platform: Windows

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
      
      - name: Install Qt dependencies (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq \
            libgl1 libegl1 libxkbcommon-x11-0 \
            libxcb-icccm4 libxcb-image0 libxcb-keysyms1 \
            libxcb-randr0 libxcb-render-util0 libxcb-xinerama0 \
            libxcb-xfixes0 libxcb-shape0 libxcb-cursor0 \
            libdbus-1-3 libfontconfig1 libglib2.0-0 \
            libgssapi-krb5-2 libx11-6 libx11-xcb1 \
            libxext6 libxrender1 libxkbcommon0 \
            fuse libfuse2 \
            build-essential ccache patchelf
      
      - name: Setup ccache (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: echo "/usr/lib/ccache" >> $GITHUB_PATH
      
      - name: Setup ccache (macOS)
        if: matrix.os == 'macos-latest'
        run: |
          brew install ccache
          echo "$(brew --prefix ccache)/libexec" >> $GITHUB_PATH
      
      - name: Setup ccache (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          choco install ccache -y
          echo "C:\ProgramData\chocolatey\bin" >> $env:GITHUB_PATH
      
      - name: Cache Nuitka builds (Linux)
        if: matrix.os == 'ubuntu-latest'
        uses: actions/cache@v4
        with:
          path: ~/.cache/Nuitka
          key: nuitka-linux-${{ hashFiles('main.py', 'canvas_*.py', 'pysidedeploy.spec') }}
          restore-keys: nuitka-linux-
      
      - name: Cache Nuitka builds (macOS)
        if: matrix.os == 'macos-latest'
        uses: actions/cache@v4
        with:
          path: ~/Library/Caches/Nuitka
          key: nuitka-macos-${{ hashFiles('main.py', 'canvas_*.py', 'pysidedeploy.spec') }}
          restore-keys: nuitka-macos-
      
      - name: Cache Nuitka builds (Windows)
        if: matrix.os == 'windows-latest'
        uses: actions/cache@v4
        with:
          path: ~\AppData\Local\Nuitka
          key: nuitka-windows-${{ hashFiles('main.py', 'canvas_*.py', 'pysidedeploy.spec') }}
          restore-keys: nuitka-windows-
      
      - name: Install Python dependencies
        run: |
          pip install -r requirements.txt
          pip install nuitka ordered-set zstandard imageio
          pip install -e .
      
      - name: Inject version from git tag
        shell: bash
        run: |
          VERSION="${{ github.ref_name }}"
          VERSION_NUMBER="${VERSION#v}"
          
          # For non-tag builds (branches), use a dev version
          if [[ "$VERSION_NUMBER" == *"/"* ]]; then
            VERSION_NUMBER="0.0.0-dev"
          fi
          
          # Use temp file approach with | delimiter to avoid conflicts
          sed "s|__VERSION__|$VERSION_NUMBER|g" pysidedeploy.spec > pysidedeploy.spec.tmp
          mv pysidedeploy.spec.tmp pysidedeploy.spec
          sed "s|__VERSION__|$VERSION_NUMBER|g" main.py > main.py.tmp
          mv main.py.tmp main.py
          
          echo "Building version: $VERSION_NUMBER"
          
          # Export sanitized ref name for artifact naming (replace / with -)
          SAFE_REF_NAME=$(echo "${{ github.ref_name }}" | tr '/' '-')
          echo "SAFE_REF_NAME=$SAFE_REF_NAME" >> $GITHUB_ENV
      
      - name: Build with pyside6-deploy (Linux)
        if: matrix.os == 'ubuntu-latest'
        env:
          CC: gcc
          CXX: g++
        run: |
          pyside6-deploy -c pysidedeploy.spec --force
      
      - name: Build with pyside6-deploy (macOS/Windows)
        if: matrix.os != 'ubuntu-latest'
        run: |
          pyside6-deploy -c pysidedeploy.spec --force
      
      - name: Verify build output
        shell: bash
        run: |
          if [ ! -d "Lucent.app" ] && [ ! -f "Lucent.exe" ] && [ ! -f "Lucent.bin" ]; then
            echo "ERROR: Build output not found"
            exit 1
          fi
      
      - name: Package Linux executable
        if: matrix.os == 'ubuntu-latest'
        run: |
          mv Lucent.bin Lucent
          chmod +x Lucent
          tar -czvf "Lucent-${SAFE_REF_NAME}-Linux-x86_64.tar.gz" Lucent
      
      - name: Create DMG (macOS)
        if: matrix.os == 'macos-latest'
        run: |
          hdiutil create -volname "Lucent" \
            -srcfolder Lucent.app \
            -ov -format UDZO \
            "Lucent-${SAFE_REF_NAME}-macOS.dmg"
      
      - name: Package Windows executable
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          Compress-Archive -Path Lucent.exe -DestinationPath "Lucent-$env:SAFE_REF_NAME-Windows.zip"
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: Lucent-${{ env.SAFE_REF_NAME }}-${{ matrix.platform }}
          path: Lucent-*
  
  release:
    name: Create GitHub Release
    needs: build
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
      
      - name: Generate release notes
        id: release_notes
        run: |
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          
          if [ -z "$PREV_TAG" ]; then
            COMMITS=$(git log --pretty=format:"%s (%h)" --no-merges)
          else
            COMMITS=$(git log ${PREV_TAG}..HEAD --pretty=format:"%s (%h)" --no-merges)
          fi
          
          FEATURES=()
          BUGS=()
          OTHER=()

          while IFS= read -r line; do
            [ -z "$line" ] && continue
            type_part=${line%% *}
            type_part=${type_part%%:*}
            type_part=${type_part,,}
            case "$type_part" in
              feature|feat) FEATURES+=("$line") ;;
              bug|fix) BUGS+=("$line") ;;
              *) OTHER+=("$line") ;;
            esac
          done <<< "$COMMITS"

          {
            echo "## What's Changed"
            echo ""

            if [ ${#FEATURES[@]} -gt 0 ]; then
              echo "### Features Created :tada:"
              echo ""
              for item in "${FEATURES[@]}"; do
                echo "- $item"
              done
              echo ""
            fi

            if [ ${#BUGS[@]} -gt 0 ]; then
              echo "### Bugs Squashed :bug:"
              echo ""
              for item in "${BUGS[@]}"; do
                echo "- $item"
              done
              echo ""
            fi

            if [ ${#OTHER[@]} -gt 0 ]; then
              echo "### Housekeeping :broom:"
              echo ""
              for item in "${OTHER[@]}"; do
                echo "- $item"
              done
              echo ""
            fi
          } > release_notes.md
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          body_path: release_notes.md
          append_body: true
          files: |
            Lucent-*-Linux/*
            Lucent-*-macOS/*
            Lucent-*-Windows/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

